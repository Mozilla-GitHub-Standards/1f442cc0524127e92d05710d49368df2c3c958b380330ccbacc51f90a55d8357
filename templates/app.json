{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "MIG application",
    "Parameters": {
        "Environment": {
            "AllowedValues": [
                "dev",
                "stage",
                "prod"
            ],
            "Default": "dev",
            "Description": "Environment",
            "Type": "String"
        },
        "ImageId": {
            "Description": "AMI",
            "Type": "String"
        },
        "ApiInstanceType": {
            "Default": "t2.micro",
            "Description": "Instance type",
            "Type": "String"
        },
        "KeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "BaseStack": {
            "Description": "Name of base stack",
            "Type": "String"
        },
        "APICertName": {
            "Type": "String",
            "Description": "Name of certificate to use for API"
        }
    },
    "Resources": {
        "LaunchConfiguration": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "ImageId": { "Ref": "ImageId" },
                "InstanceType": { "Ref": "ApiInstanceType" },
                "KeyName": { "Ref": "KeyName" },
                "SecurityGroups": [ { "Ref": "APISecurityGroup" } ]
            }
        },
        "AutoScalingGroup": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "Properties": {
                "LaunchConfigurationName": { "Ref": "LaunchConfiguration" },
                "MinSize": "2",
                "MaxSize": "2",
                "HealthCheckGracePeriod": "500",
                "HealthCheckType": "EC2",
                "LoadBalancerNames": [ { "Ref": "APIELB" } ],
                "VPCZoneIdentifier": [ { "Fn::ImportValue": { "Fn::Sub": "${BaseStack}-PrivateSubnet" }} ],
                "Tags": [
                    { "Key": "Name", "Value": "mig api", "PropagateAtLaunch": "true" }
                ],
            }
        },
        "APIELB": {
            "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties": {
                "Tags": [
                    { "Key": "Name", "Value": "mig api loader balancer" }
                ],
                "Policies": [
                    {
                        "PolicyName": "APIELBSecurityPolicy",
                        "PolicyType": "SSLNegotiationPolicyType",
                        "Attributes": [ {
                            "Name": "Reference-Security-Policy",
                            "Value": "ELBSecurityPolicy-2015-03"
                        } ]
                    }
                ],
                "Subnets": [ { "Fn::ImportValue": { "Fn::Sub": "${BaseStack}-PublicSubnet" }} ],
                "SecurityGroups": [ { "Ref": "APIELBSecurityGroup" } ],
                "Listeners": [ {
                    "InstancePort": "80",
                    "InstanceProtocol": "HTTP",
                    "LoadBalancerPort": "443",
                    "Protocol": "HTTPS",
                    "PolicyNames": [ "APIELBSecurityPolicy" ],
                    "SSLCertificateId": {
                        "Fn::Join": [ "",
                            [
                                "arn:aws:iam::",
                                { "Ref": "AWS::AccountId" },
                                ":server-certificate/",
                                { "Ref": "APICertName" }
                            ]
                        ]
                    }
                } ],
            }
        },
        "APISecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable SSH access to API host",
                "VpcId": { "Fn::ImportValue": { "Fn::Sub": "${BaseStack}-VPCId" }},
                "SecurityGroupIngress": [
                    { "IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "SourceSecurityGroupId": { "Fn::ImportValue": { "Fn::Sub": "${BaseStack}-BastionSecurityGroupId" }}},
                    { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "SourceSecurityGroupId": { "Ref": "APIELBSecurityGroup" }},
                ],
                "Tags": [
                    { "Key": "Name", "Value": "mig api security group" }
                ]
            }
        },
        "APIELBSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "API ELB access",
                "VpcId": { "Fn::ImportValue": { "Fn::Sub": "${BaseStack}-VPCId" }},
                "SecurityGroupIngress": [
                    { "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443", "CidrIp": "0.0.0.0/0" }
                ],
                "Tags": [
                    { "Key": "Name", "Value": "mig api elb security group" }
                ]
            }
        }
    }
}
